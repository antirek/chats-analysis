# Документация по архитектуре Prosody

Эта директория содержит документацию по архитектуре и внутреннему устройству Prosody IM Server.

## Структура документации

### [architecture.md](./architecture.md)
Общий обзор архитектуры Prosody:
- Основные компоненты системы
- Диаграммы архитектуры
- Модульная система
- Управление сессиями
- Хранение данных
- Безопасность

### [key-concepts.md](./key-concepts.md)
Детальное описание ключевых понятий:
- JID (Jabber ID) - структура и типы
- Stanza - типы и обработка
- Session - типы сессий и управление
- Host - виртуальные хосты и компоненты
- Roster - список контактов
- Events - система событий
- Storage - хранилища данных
- Filters - фильтры обработки
- Modules - модульная система
- Network - сетевые соединения

### [message-flow.md](./message-flow.md)
Детальное описание потока обработки сообщений:
- Локальная доставка (один сервер)
- Удаленная доставка (разные серверы)
- Сообщения на full JID
- Сообщения без 'to' атрибута
- Обработка ошибок
- Оптимизации

## Быстрый старт

### Для понимания общей архитектуры
1. Начните с [architecture.md](./architecture.md) - общий обзор
2. Изучите [key-concepts.md](./key-concepts.md) - ключевые понятия
3. Перейдите к [message-flow.md](./message-flow.md) - детали обработки

### Для понимания маршрутизации сообщений
1. Прочитайте раздел "Поток обработки сообщения" в [architecture.md](./architecture.md)
2. Изучите [message-flow.md](./message-flow.md) - детальные сценарии
3. Обратите внимание на диаграммы последовательности

### Для разработки модулей
1. Изучите раздел "Модульная система" в [architecture.md](./architecture.md)
2. Прочитайте раздел "Modules" в [key-concepts.md](./key-concepts.md)
3. Изучите примеры в директории `plugins/`

## Диаграммы

Все диаграммы созданы с использованием [Mermaid](https://mermaid.js.org/). Для просмотра диаграмм:

1. Используйте редактор с поддержкой Mermaid (VS Code, GitHub, GitLab)
2. Или используйте онлайн-редактор: https://mermaid.live/
3. Или установите расширение для браузера

## Ключевые файлы кода

### Основные компоненты
- `core/stanza_router.lua` - маршрутизация станз
- `core/sessionmanager.lua` - управление сессиями
- `core/hostmanager.lua` - управление хостами
- `core/modulemanager.lua` - управление модулями
- `core/rostermanager.lua` - управление рострами
- `core/s2smanager.lua` - управление s2s соединениями

### Модули обработки
- `plugins/mod_message.lua` - обработка сообщений
- `plugins/mod_presence.lua` - обработка presence
- `plugins/mod_iq.lua` - обработка IQ запросов
- `plugins/mod_s2s.lua` - межсерверная коммуникация

## Дополнительные ресурсы

### Официальная документация
- [Prosody Documentation](https://prosody.im/doc/)
- [XMPP Standards](https://xmpp.org/extensions/)

### RFC документы
- [RFC 6120: XMPP Core](https://tools.ietf.org/html/rfc6120)
- [RFC 6121: XMPP Instant Messaging and Presence](https://tools.ietf.org/html/rfc6121)
- [RFC 6122: XMPP Address Format](https://tools.ietf.org/html/rfc6122)

### Внутренняя документация Prosody
- `doc/stanza_routing.txt` - правила маршрутизации станз
- `doc/stanza.txt` - структура станз
- `doc/session.txt` - описание сессий

## Соглашения

### Обозначения в диаграммах
- **Прямоугольники** - компоненты/модули
- **Ромбы** - точки принятия решений
- **Стрелки** - поток данных/управления
- **Пунктирные линии** - альтернативные пути

### Терминология
- **Stanza** - базовый XML элемент в XMPP
- **JID** - Jabber ID, идентификатор пользователя
- **C2S** - Client-to-Server соединение
- **S2S** - Server-to-Server соединение
- **Resource** - идентификатор клиента/устройства

## Вклад в документацию

При обновлении документации:
1. Обновляйте соответствующие разделы
2. Обновляйте диаграммы при изменении архитектуры
3. Добавляйте примеры кода при необходимости
4. Проверяйте корректность ссылок на файлы кода

## Лицензия

Документация распространяется под той же лицензией, что и Prosody (MIT/X11).
